{% extends "registro/base.html" %}
{% block titulo %}Registrar{% endblock %}
{% block cuerpo %}
<form method="post">{% csrf_token %}
  {{ form.as_p }}
  <input type="submit" value="Submit" />
</form>
<script>
  (function(){

    // 1. Buscar el elemento en el DOM que hará que el segundo select sea llenado
    var id_estado = document.getElementById("id_estado");
    var id_municipio = document.getElementById("id_municipio");
    var id_parroquia = document.getElementById("id_parroquia");

    // 2. Crear un array con los municipios de cada estado
    // @for estado in estados: Se consultan los estados disponibles traídos desde la consulta en la base de datos.
    // @param estado_{{ estado.id }}: Se crea un array por cada estado disponible en la base de datos.
    // @for municipio in municipios: Se consultan los municipios disponibles traídos desde la consulta en la base de datos.
    // @if municipio.estado_perteneciente.id == estado.id   Si el id del municipio concuerda con el id del estado, mete el nombre del municipio en el array del estado correspondiente.

    {% for estado in estados %}
      var estado_{{ estado.id }} = new Array();
      var estado_{{ estado.id }}_id = new Array();
      {% for municipio in municipios %}
        {% if municipio.estado_perteneciente.id == estado.id %}
          var municipio_{{municipio.id }} = new Array();
          var municipio_{{municipio.id }}_id = new Array();
          estado_{{ estado.id }}.push('{{ municipio.nombre_municipio }}');
          estado_{{ estado.id }}_id.push('{{ municipio.id }}');
          {% for parroquia in parroquias %}
            {% if parroquia.municipio_perteneciente.id == municipio.id %}
              municipio_{{municipio.id }}.push('{{ parroquia.nombre_parroquia }}');
              municipio_{{municipio.id }}_id.push('{{ parroquia.id }}');
            {% endif %}
          {% endfor %}
        {% endif %}
      {% endfor %}
    {% endfor %}

    // 3. Crear el evento que escuchará e imprimirá las opciones al cambiar el select "estado" 
    id_estado.addEventListener('change',function(){
      // Valor del select "id_estado"
      let estado_seleccionado = this.value;
      // Verifica la validez de estado_seleccionado
      if(estado_seleccionado != 0) {
        // Selecciona el array que se llame como el servicio que se seleccionó
        array_del_estado = eval("estado_" + estado_seleccionado);
        array_del_estado_id = eval("estado_" + estado_seleccionado + "_id");
        // Calcula el número de elementos que se imprimirá en el combobox
        cantidad_municipios = array_del_estado.length;
        // Se le asigna el largo de array al combobox
        id_municipio.length = cantidad_municipios + 1;
        id_municipio.options[0].value = "";
        id_municipio.options[0].text = "-----";
        // Imprime las opciones en el combobox
        for(i=0; i < cantidad_municipios; i++){
          id_municipio.options[i+1].value = array_del_estado_id[i];
          id_municipio.options[i+1].text = array_del_estado[i];
        }
      }
      else {
        // si no habia ninguna opt seleccionada, se eliminan  del select
        id_municipio.length = 1;
        //ponemos un guion en la unica opt que he dejado
        id_municipio.options[0].value="";
        id_municipio.options[0].text="Seleccione un municipio";
      }
      id_municipio.options[0].selected = true;
    }, true);
    id_municipio.addEventListener('change',function(){
      // Valor del select "id_estado"
      let estado_seleccionado = this.value;
      // Verifica la validez de estado_seleccionado
      if(estado_seleccionado != 0) {
        // Selecciona el array que se llame como el servicio que se seleccionó
        array_del_estado = eval("municipio_" + estado_seleccionado);
        array_del_estado_id = eval("municipio_" + estado_seleccionado + "_id");
        // Calcula el número de elementos que se imprimirá en el combobox
        cantidad_municipios = array_del_estado.length;
        // Se le asigna el largo de array al combobox
        id_parroquia.length = cantidad_municipios + 1;
        id_parroquia.options[0].value = "";
        id_parroquia.options[0].text = "-----";
        // Imprime las opciones en el combobox
        for(i=0; i < cantidad_municipios; i++){
          id_parroquia.options[i+1].value = array_del_estado_id[i];
          id_parroquia.options[i+1].text = array_del_estado[i];
        }
      }
      else {
        // si no habia ninguna opt seleccionada, se eliminan  del select
        id_parroquia.length = 1;
        //ponemos un guion en la unica opt que he dejado
        id_parroquia.options[0].value="";
        id_parroquia.options[0].text="Seleccione un municipio";
      }
      // Hace un reset de las opciones
      id_parroquia.options[0].selected = true;
    }, true);
    })();
</script>
{% endblock %}